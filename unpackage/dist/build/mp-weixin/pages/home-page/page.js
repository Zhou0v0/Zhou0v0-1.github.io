(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/home-page/page"],{3060:function(t,e,n){"use strict";(function(t,e){var i=n("4ea4");n("caec");i(n("66fd"));var o=i(n("c357"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(o.default)}).call(this,n("bc2e")["default"],n("543d")["createPage"])},"38db":function(t,e,n){"use strict";var i=n("668d"),o=n.n(i);o.a},5048:function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){}));var i=function(){var t=this,e=t.$createElement;t._self._c;t._isMounted||(t.e0=function(e){e.stopPropagation(),0!=t.total_quantity&&t.placean_order()})},o=[]},"59af":function(t,e,n){"use strict";n.r(e);var i=n("7a10"),o=n.n(i);for(var a in i)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(a);e["default"]=o.a},"668d":function(t,e,n){},"7a10":function(t,e,n){"use strict";(function(t){var i=n("4ea4");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=i(n("2eee")),a=i(n("c973")),s=n("c96f"),r=n("038e"),u=getApp(),c=u.globalData.Modelmes,d=t.cloud.database(),h=d.command,l=d.collection("order-data"),p=d.collection("dishes-data"),f={components:{Cart:function(){n.e("pages/home-page/components/shopping-cart").then(function(){return resolve(n("3b87"))}.bind(null,n)).catch(n.oe)},Details:function(){n.e("pages/home-page/components/goods-details").then(function(){return resolve(n("2a19"))}.bind(null,n)).catch(n.oe)},Home:function(){n.e("pages/skeleton-view/home").then(function(){return resolve(n("d8c9"))}.bind(null,n)).catch(n.oe)}},data:function(){return{exist:!0,Modelmes:c,itemize:[],trigger:0,goods:[],heightset:[],tophei:0,scroll_into:"",card:!1,shopping_card:[],popupitem:!1,pro_details:{},tmplIds:"GGoyslwCarWdGPHPhyxi35SzpuvxVehVOxTM6LPo8Y8",number_people:0}},methods:{itemIze:function(t,e){var n=this;this.trigger=t,this.scroll_into=e,setTimeout((function(){n.scroll_into=""}),200)},scroLl:function(t){var e=t.detail.scrollTop;e>=this.tophei?e>=this.heightset[this.trigger]&&(this.trigger+=1):e<this.heightset[this.trigger-1]&&(this.trigger-=1),this.tophei=e},plus:function(t,e,n,i){var o=i.quantity,a=i.image,s=i.name,r=i.unitprice,u=i.unit,c=i._id,d=o+1;this.$set(this.goods[t].good_query[e],"quantity",d);var h={image:a,name:s,unitprice:r,quantity:d,unit:u,total_price:r*d,_id:c,cid:n,good_index:e};this.shopping_Cart(h)},reduce:function(t,e,n,i){var o=i.quantity,a=i.image,s=i.name,r=i.unitprice,u=i.unit,c=i._id,d=o-1;this.$set(this.goods[t].good_query[e],"quantity",d);var h={image:a,name:s,unitprice:r,quantity:d,unit:u,total_price:r*d,_id:c,cid:n,good_index:e};this.shopping_Cart(h)},shopping_Cart:function(t){if(0==this.shopping_card.length)this.shopping_card.push(t);else{var e=this.shopping_card.findIndex((function(e){return e._id==t._id}));-1==e?this.shopping_card.unshift(t):(this.$set(this.shopping_card[e],"quantity",t.quantity),this.$set(this.shopping_card[e],"total_price",t.total_price))}console.log(this.shopping_card),this.qunint_of_goods()},qunint_of_goods:function(){var t=this,e=this.shopping_card,n={};e.forEach((function(t){n[t.cid]?n[t.cid]+=t.quantity:n[t.cid]=t.quantity}));var i=[];for(var o in n)i.push({cid:o,value:n[o]});i.forEach((function(e){var n=t.itemize.findIndex((function(t){return t.cid==e.cid}));t.$set(t.itemize[n],"sele_quantity",e.value)}))},shopping_Cart_add_sub:function(t,e,n,i,o,a){this.$set(this.shopping_card[t],"quantity",e),this.$set(this.shopping_card[t],"total_price",e*a);var s=this.goods.findIndex((function(t){return t.cid==i}));this.$set(this.goods[s].good_query[o],"quantity",e),this.qunint_of_goods()},empty_data:function(){this.shopping_card=[],this.itemize.forEach((function(t){t.sele_quantity=0})),this.goods.forEach((function(t){t.good_query.forEach((function(t){t.quantity=0}))})),this.pop_Shopping(!1)},popup_item:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;this.popupitem=t,this.pro_details={index:e,good_index:n,cid:i,itemgood:o}},pop_Shopping:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.card=t},dishEs:function(){var e=this;return(0,a.default)(o.default.mark((function n(){var i;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,t.cloud.callFunction({name:"Dish-manage",data:{}});case 2:i=n.sent,e.itemize=i.result.res_cate,e.goods=i.result.res_dis,e.$nextTick((function(){e.goods_height()}));case 6:case"end":return n.stop()}}),n)})))()},goods_height:function(){var e=this;this.heightset=[];var n=0,i=t.createSelectorQuery();i.selectAll(".rig-height").boundingClientRect(),i.exec((function(t){t[0].forEach((function(t){n+=t.height,e.heightset.push(n)})),e.exist=!1}))},placean_order:function(){var e=this;t.requestSubscribeMessage({tmplIds:[this.tmplIds],success:function(t){e.sub_database()},fail:function(t){e.sub_database()}})},sub_database:function(){var e=this;return(0,a.default)(o.default.mark((function n(){var i,u,c,d,f,g,_,m,v;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return t.showLoading({title:"正在下单",mask:!0}),i=e.shopping_card.filter((function(t){return 0!=t.total_price})),u=0,i.forEach((function(t){u+=t.total_price})),c=t.getStorageSync("table_num"),d=t.getStorageSync("number_of_diners"),f={table_number:c,number_of_diners:d,order_time:e.$Time().utcOffset(8).format("YYYY-MM-DD HH:mm:ss"),sett_amount:u,order_no:(0,s.Code)(),transac_status:"unsettled",order_receiving:"mis_orders",menu:[{backup_data:"备用字段",goods_list:i}]},g={backup_data:"备用字段",goods_list:i},n.prev=8,n.next=11,l.where({table_number:c,transac_status:"unsettled"}).field({_id:!0,sett_amount:!0}).get();case 11:if(_=n.sent,0!=_.data.length){n.next=17;break}return n.next=15,l.add({data:f});case 15:n.next=20;break;case 17:return m=Number(_.data[0].sett_amount)+u,n.next=20,l.doc(_.data[0]._id).update({data:{sett_amount:m,order_receiving:"mis_orders",menu:h.unshift(g)}});case 20:return i.forEach(function(){var t=(0,a.default)(o.default.mark((function t(e){return o.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,p.doc(e._id).update({data:{monthlysale:h.inc(e.quantity)}});case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),v=e.$Time().utcOffset(8).format("YYYY-MM-DD"),n.next=24,(new r.analysis).sameday(v,u);case 24:e.push_message(),t.redirectTo({url:"/pages/order-details/details"}),t.hideLoading(),n.next=32;break;case 29:n.prev=29,n.t0=n["catch"](8),t.showToast({title:"发生错误",icon:"error"});case 32:case"end":return n.stop()}}),n,null,[[8,29]])})))()},push_message:function(){var t=this.goeasy.pubsub;t.publish({channel:"my_channel",message:"小程序端来的",onSuccess:function(){console.log("消息发布成功。")},onFailed:function(t){console.log("消息发送失败，错误编码："+t.code+" 错误信息："+t.content)}})},my_order:function(){t.navigateTo({url:"/pages/my-order/my-order"})}},onLoad:function(){this.number_people=t.getStorageSync("number_of_diners"),this.dishEs()},computed:{total_quantity:function(){var t=0;return this.shopping_card.forEach((function(e){t+=e.quantity})),t}}};e.default=f}).call(this,n("bc2e")["default"])},c357:function(t,e,n){"use strict";n.r(e);var i=n("5048"),o=n("59af");for(var a in o)["default"].indexOf(a)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(a);n("38db");var s=n("f0c5"),r=Object(s["a"])(o["default"],i["b"],i["c"],!1,null,"6143861f",null,!1,i["a"],void 0);e["default"]=r.exports}},[["3060","common/runtime","common/vendor"]]]);